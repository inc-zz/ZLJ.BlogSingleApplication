@page
@model Blogs.AdminSite.Pages.Permissions.RoleModel
@{
    Layout = "_layout";
    ViewData["Title"] = "角色管理";
}


<!-- 主内容区域 -->
<div class="container-fluid">
    <!-- 页面标题 -->
    <div class="page-header">
        <h1>角色管理</h1>
        <p class="text-muted">管理系统角色，分配权限和用户</p>
    </div>

    <!-- 搜索和操作区域 -->
    <div class="card">
        <div class="card-body">
            <div class="row g-3 align-items-end">
                <div class="col-md-4">
                    <label class="form-label">角色名称</label>
                    <div class="search-container">
                        <input type="text" class="form-control" id="searchRoleName" placeholder="请输入角色名称">
                        <i class="fas fa-search search-icon"></i>
                    </div>
                </div>
                <div class="col-md-4">
                    <label class="form-label">状态</label>
                    <select class="form-select" id="searchRoleStatus">
                        <option value="">全部</option>
                        <option value="1">启用</option>
                        <option value="0">禁用</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <button type="button" class="btn btn-primary w-100" id="searchRoleBtn">
                        <i class="fas fa-search me-2"></i>搜索
                    </button>
                </div>
            </div>

            <div class="d-flex justify-content-between mt-3">
                <div>
                    <button class="btn btn-success" id="addRoleBtn">
                        <i class="fas fa-plus me-2"></i> 添加角色
                    </button>
                    <button class="btn btn-danger" id="batchDeleteRoleBtn">
                        <i class="fas fa-trash me-2"></i> 批量删除
                    </button>
                </div>
                <div>
                    <button class="btn btn-outline-secondary" id="refreshRoleBtn">
                        <i class="fas fa-refresh me-2"></i> 刷新
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 角色表格 -->
    <div class="card mt-4">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover" id="roleTable">
                    <thead>
                        <tr>
                            <th width="40">
                                <input type="checkbox" id="checkAllRoles">
                            </th>
                            <th>ID</th>
                            <th>角色名称</th>
                            <th>描述</th>
                            <th>权限数量</th>
                            <th>用户数量</th>
                            <th>状态</th>
                            <th>创建时间</th>
                            <th width="280">操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><input type="checkbox" class="role-checkbox" value="1"></td>
                            <td>1</td>
                            <td>超级管理员</td>
                            <td>系统最高权限角色，拥有所有权限</td>
                            <td>35</td>
                            <td>2</td>
                            <td><span class="badge bg-success">启用</span></td>
                            <td>2023-01-15</td>
                            <td>
                                <button class="btn btn-sm btn-primary edit-role-btn btn-fixed-width" data-id="1">
                                    <i class="fas fa-edit btn-icon"></i>编辑
                                </button>
                                <button class="btn btn-sm btn-info assign-permission-btn btn-fixed-width" data-id="1">
                                    <i class="fas fa-key btn-icon"></i>权限
                                </button>
                                <button class="btn btn-sm btn-danger delete-role-btn btn-fixed-width" data-id="1">
                                    <i class="fas fa-trash btn-icon"></i>删除
                                </button>
                            </td>
                        </tr>
                        <tr>
                            <td><input type="checkbox" class="role-checkbox" value="2"></td>
                            <td>2</td>
                            <td>内容编辑</td>
                            <td>负责文章编辑和发布</td>
                            <td>15</td>
                            <td>8</td>
                            <td><span class="badge bg-success">启用</span></td>
                            <td>2023-02-20</td>
                            <td>
                                <button class="btn btn-sm btn-primary edit-role-btn btn-fixed-width" data-id="2">
                                    <i class="fas fa-edit btn-icon"></i>编辑
                                </button>
                                <button class="btn btn-sm btn-info assign-permission-btn btn-fixed-width" data-id="2">
                                    <i class="fas fa-key btn-icon"></i>权限
                                </button>
                                <button class="btn btn-sm btn-danger delete-role-btn btn-fixed-width" data-id="2">
                                    <i class="fas fa-trash btn-icon"></i>删除
                                </button>
                            </td>
                        </tr>
                        <tr>
                            <td><input type="checkbox" class="role-checkbox" value="3"></td>
                            <td>3</td>
                            <td>评论审核员</td>
                            <td>负责评论审核和管理</td>
                            <td>8</td>
                            <td>3</td>
                            <td><span class="badge bg-secondary">禁用</span></td>
                            <td>2023-03-10</td>
                            <td>
                                <button class="btn btn-sm btn-primary edit-role-btn btn-fixed-width" data-id="3">
                                    <i class="fas fa-edit btn-icon"></i>编辑
                                </button>
                                <button class="btn btn-sm btn-info assign-permission-btn btn-fixed-width" data-id="3">
                                    <i class="fas fa-key btn-icon"></i>权限
                                </button>
                                <button class="btn btn-sm btn-danger delete-role-btn btn-fixed-width" data-id="3">
                                    <i class="fas fa-trash btn-icon"></i>删除
                                </button>
                            </td>
                        </tr>
                        <tr>
                            <td><input type="checkbox" class="role-checkbox" value="4"></td>
                            <td>4</td>
                            <td>访客</td>
                            <td>只读权限，可以浏览内容</td>
                            <td>5</td>
                            <td>156</td>
                            <td><span class="badge bg-success">启用</span></td>
                            <td>2023-04-05</td>
                            <td>
                                <button class="btn btn-sm btn-primary edit-role-btn btn-fixed-width" data-id="4">
                                    <i class="fas fa-edit btn-icon"></i>编辑
                                </button>
                                <button class="btn btn-sm btn-info assign-permission-btn btn-fixed-width" data-id="4">
                                    <i class="fas fa-key btn-icon"></i>权限
                                </button>
                                <button class="btn btn-sm btn-danger delete-role-btn btn-fixed-width" data-id="4">
                                    <i class="fas fa-trash btn-icon"></i>删除
                                </button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- 分页 -->
            <div class="d-flex justify-content-between align-items-center mt-3">
                <div>显示第 1 到 4 条，共 12 条记录</div>
                <nav>
                    <ul class="pagination">
                        <li class="page-item disabled"><a class="page-link" href="#">上一页</a></li>
                        <li class="page-item active"><a class="page-link" href="#">1</a></li>
                        <li class="page-item"><a class="page-link" href="#">2</a></li>
                        <li class="page-item"><a class="page-link" href="#">3</a></li>
                        <li class="page-item"><a class="page-link" href="#">下一页</a></li>
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>


<!-- 模态框区域 -->
<!-- 添加/编辑角色模态框 -->
<div class="modal fade" id="roleModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="roleModalTitle">添加角色</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form class="layui-form" id="roleForm">
                    <input type="hidden" id="roleId">
                    <div class="layui-form-item">
                        <label class="layui-form-label">角色名称</label>
                        <div class="layui-input-block">
                            <input type="text" id="roleName" name="roleName" lay-verify="required" placeholder="请输入角色名称" class="layui-input">
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">角色代码</label>
                        <div class="layui-input-block">
                            <input type="text" id="roleCode" name="roleCode" lay-verify="required" placeholder="请输入角色代码" class="layui-input">
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">描述</label>
                        <div class="layui-input-block">
                            <textarea id="roleDescription" name="roleDescription" placeholder="请输入角色描述" class="layui-textarea"></textarea>
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">状态</label>
                        <div class="layui-input-block">
                            <input type="checkbox" id="roleStatus" name="status" lay-skin="switch" lay-text="启用|禁用" checked>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="saveRoleBtn">
                    <i class="fas fa-save me-2"></i>保存
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 分配权限模态框 -->
<div class="modal fade" id="assignPermissionModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">分配权限</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>为角色 <strong id="assignPermissionRoleName">超级管理员</strong> 分配权限：</p>
                <div class="permission-tree">
                    <div class="permission-group">用户管理</div>
                    <div class="permission-item">
                        <input type="checkbox" id="perm1" class="permission-checkbox-modal" value="1">
                        <label for="perm1">查看用户</label>
                    </div>
                    <div class="permission-item">
                        <input type="checkbox" id="perm2" class="permission-checkbox-modal" value="2">
                        <label for="perm2">添加用户</label>
                    </div>
                    <div class="permission-item">
                        <input type="checkbox" id="perm3" class="permission-checkbox-modal" value="3">
                        <label for="perm3">编辑用户</label>
                    </div>
                    <div class="permission-item">
                        <input type="checkbox" id="perm4" class="permission-checkbox-modal" value="4">
                        <label for="perm4">删除用户</label>
                    </div>

                    <div class="permission-group">文章管理</div>
                    <div class="permission-item">
                        <input type="checkbox" id="perm5" class="permission-checkbox-modal" value="5">
                        <label for="perm5">查看文章</label>
                    </div>
                    <div class="permission-item">
                        <input type="checkbox" id="perm6" class="permission-checkbox-modal" value="6">
                        <label for="perm6">发布文章</label>
                    </div>
                    <div class="permission-item">
                        <input type="checkbox" id="perm7" class="permission-checkbox-modal" value="7">
                        <label for="perm7">编辑文章</label>
                    </div>
                    <div class="permission-item">
                        <input type="checkbox" id="perm8" class="permission-checkbox-modal" value="8">
                        <label for="perm8">删除文章</label>
                    </div>

                    <div class="permission-group">系统管理</div>
                    <div class="permission-item">
                        <input type="checkbox" id="perm9" class="permission-checkbox-modal" value="9">
                        <label for="perm9">系统设置</label>
                    </div>
                    <div class="permission-item">
                        <input type="checkbox" id="perm10" class="permission-checkbox-modal" value="10">
                        <label for="perm10">日志查看</label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="saveAssignPermissionBtn">
                    <i class="fas fa-save me-2"></i>保存
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap 5 JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<!-- Layui JS -->
<script src="https://cdn.jsdelivr.net/npm/layui@2.8.18/dist/layui.min.js"></script>

<script>
    layui.use(['form', 'layer'], function() {
        var form = layui.form;
        var layer = layui.layer;
        var $ = layui.$;

        // 侧边栏折叠/展开功能
        document.getElementById('toggleSidebar').addEventListener('click', function() {
            document.body.classList.toggle('sidebar-collapsed');

            // 隐藏或显示所有箭头图标
            const menuArrows = document.querySelectorAll('.menu-arrow');
            menuArrows.forEach(arrow => {
                arrow.style.display = document.body.classList.contains('sidebar-collapsed') ? 'none' : 'block';
            });

            // 保存用户偏好设置到本地存储
            if (document.body.classList.contains('sidebar-collapsed')) {
                localStorage.setItem('sidebarCollapsed', 'true');
            } else {
                localStorage.setItem('sidebarCollapsed', 'false');
            }
        });

        // 页面加载时检查用户偏好设置
        document.addEventListener('DOMContentLoaded', function() {
            const sidebarCollapsed = localStorage.getItem('sidebarCollapsed');
            if (sidebarCollapsed === 'true') {
                document.body.classList.add('sidebar-collapsed');

                // 隐藏所有箭头图标
                const menuArrows = document.querySelectorAll('.menu-arrow');
                menuArrows.forEach(arrow => {
                    arrow.style.display = 'none';
                });
            }

            // 二级菜单展开/收起功能
            const submenuToggles = document.querySelectorAll('.submenu-toggle');

            submenuToggles.forEach(toggle => {
                toggle.addEventListener('click', function() {
                    const submenu = this.nextElementSibling;
                    const arrowIcon = this.querySelector('.menu-arrow');

                    // 切换子菜单的展开状态
                    submenu.classList.toggle('open');

                    // 切换箭头图标的方向
                    if (arrowIcon.classList.contains('fa-chevron-down')) {
                        arrowIcon.classList.remove('fa-chevron-down');
                        arrowIcon.classList.add('fa-chevron-up');
                    } else {
                        arrowIcon.classList.remove('fa-chevron-up');
                        arrowIcon.classList.add('fa-chevron-down');
                    }
                });
            });

            // 菜单项点击激活状态
            const menuItems = document.querySelectorAll('.sidebar-menu a');
            const currentPath = window.location.pathname;

            menuItems.forEach(item => {
                // 设置当前页面菜单项为激活状态
                if (item.getAttribute('href') === currentPath ||
                    (currentPath === '/' && item.getAttribute('href') === '/')) {
                    item.classList.add('active');

                    // 自动展开父级菜单
                    const parentMenu = item.closest('.submenu');
                    if (parentMenu) {
                        parentMenu.classList.add('open');
                        const toggle = parentMenu.previousElementSibling;
                        if (toggle) {
                            const arrowIcon = toggle.querySelector('.menu-arrow');
                            if (arrowIcon) {
                                arrowIcon.classList.remove('fa-chevron-down');
                                arrowIcon.classList.add('fa-chevron-up');
                            }
                        }
                    }
                }

                item.addEventListener('click', function(e) {
                    if (this.classList.contains('submenu-toggle')) {
                        e.preventDefault();
                        return;
                    }

                    menuItems.forEach(i => i.classList.remove('active'));
                    this.classList.add('active');
                });
            });

            // 角色管理功能初始化
            initRoleManagement();
        });

        // 响应式处理
        window.addEventListener('resize', function() {
            if (window.innerWidth <= 768) {
                document.body.classList.add('sidebar-collapsed');

                // 隐藏所有箭头图标
                const menuArrows = document.querySelectorAll('.menu-arrow');
                menuArrows.forEach(arrow => {
                    arrow.style.display = 'none';
                });
            }
        });

        // 角色管理功能
        function initRoleManagement() {
            // 全选/取消全选
            $('#checkAllRoles').on('change', function() {
                $('.role-checkbox').prop('checked', $(this).prop('checked'));
            });

            // 添加角色按钮点击事件
            $('#addRoleBtn').on('click', function() {
                $('#roleModalTitle').text('添加角色');
                $('#roleForm')[0].reset();
                $('#roleId').val('');
                form.render();

                var modal = new bootstrap.Modal(document.getElementById('roleModal'));
                modal.show();
            });

            // 编辑角色按钮点击事件
            $('.edit-role-btn').on('click', function() {
                var roleId = $(this).data('id');
                var row = $(this).closest('tr');

                // 模拟从服务器获取数据
                $('#roleModalTitle').text('编辑角色');
                $('#roleId').val(roleId);
                $('#roleName').val(row.find('td:eq(2)').text());
                $('#roleCode').val(row.find('td:eq(2)').text().toLowerCase().replace(/\s+/g, '_'));
                $('#roleDescription').val(row.find('td:eq(3)').text());

                // 设置状态
                var status = row.find('td:eq(6)').text().trim() === '启用' ? true : false;
                $('#roleStatus').prop('checked', status);

                form.render();

                var modal = new bootstrap.Modal(document.getElementById('roleModal'));
                modal.show();
            });

            // 分配权限按钮点击事件
            $('.assign-permission-btn').on('click', function() {
                var roleId = $(this).data('id');
                var roleName = $(this).closest('tr').find('td:eq(2)').text();

                $('#assignPermissionRoleName').text(roleName);

                // 模拟从服务器获取角色当前权限
                $('.permission-checkbox-modal').prop('checked', false);
                if (roleId == 1) {
                    // 超级管理员拥有所有权限
                    $('.permission-checkbox-modal').prop('checked', true);
                } else if (roleId == 2) {
                    // 内容编辑拥有文章相关权限
                    $('#perm5, #perm6, #perm7, #perm8').prop('checked', true);
                } else if (roleId == 4) {
                    // 访客只有查看权限
                    $('#perm1, #perm5').prop('checked', true);
                }

                var modal = new bootstrap.Modal(document.getElementById('assignPermissionModal'));
                modal.show();
            });

            // 保存角色
            $('#saveRoleBtn').on('click', function() {
                // 表单验证
                if ($('#roleName').val().trim() === '') {
                    layer.msg('请输入角色名称', {icon: 2});
                    return;
                }

                if ($('#roleCode').val().trim() === '') {
                    layer.msg('请输入角色代码', {icon: 2});
                    return;
                }

                // 模拟保存操作
                layer.msg('保存成功', {icon: 1});

                // 关闭模态框
                var modal = bootstrap.Modal.getInstance(document.getElementById('roleModal'));
                modal.hide();
            });

            // 保存分配权限
            $('#saveAssignPermissionBtn').on('click', function() {
                var selectedPermissions = [];
                $('.permission-checkbox-modal:checked').each(function() {
                    selectedPermissions.push($(this).next('label').text());
                });

                // 模拟保存操作
                layer.msg('权限分配成功: ' + selectedPermissions.length + ' 个权限', {icon: 1});

                // 关闭模态框
                var modal = bootstrap.Modal.getInstance(document.getElementById('assignPermissionModal'));
                modal.hide();
            });

            // 删除角色
            $('.delete-role-btn').on('click', function() {
                var roleId = $(this).data('id');
                var roleName = $(this).closest('tr').find('td:eq(2)').text();

                layer.confirm('确定要删除角色 "' + roleName + '" 吗？', {
                    icon: 3,
                    title: '删除确认'
                }, function(index) {
                    // 模拟删除操作
                    layer.msg('删除成功', {icon: 1});
                    layer.close(index);
                });
            });

            // 批量删除
            $('#batchDeleteRoleBtn').on('click', function() {
                var checkedBoxes = $('.role-checkbox:checked');
                if (checkedBoxes.length === 0) {
                    layer.msg('请选择要删除的角色', {icon: 2});
                    return;
                }

                var roleNames = [];
                checkedBoxes.each(function() {
                    var roleName = $(this).closest('tr').find('td:eq(2)').text();
                    roleNames.push(roleName);
                });

                layer.confirm('确定要删除选中的 ' + checkedBoxes.length + ' 个角色吗？<br>' + roleNames.join(', '), {
                    icon: 3,
                    title: '批量删除确认'
                }, function(index) {
                    // 模拟删除操作
                    layer.msg('删除成功', {icon: 1});
                    layer.close(index);
                });
            });

            // 搜索功能
            $('#searchRoleBtn').on('click', function() {
                var name = $('#searchRoleName').val();
                var status = $('#searchRoleStatus').val();

                // 模拟搜索操作
                layer.msg('搜索完成', {icon: 1});
            });

            // 刷新功能
            $('#refreshRoleBtn').on('click', function() {
                // 模拟刷新操作
                layer.msg('数据已刷新', {icon: 1});
            });
        }
    });
</script>